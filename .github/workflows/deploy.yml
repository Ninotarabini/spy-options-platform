name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Docker Build, Scan & Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  NAMESPACE: spy-options-bot
  RELEASE_NAME: spy-bot
  
jobs:
  deploy:
    name: Helm Upgrade
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      # 1. CHECKOUT - Obtener Helm chart
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. SETUP KUBECTL - CLI Kubernetes
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      # 3. SETUP HELM - Package manager
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      # 4. CONFIGURE KUBECONFIG - Acceso remoto al cluster
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl config view --minify
          
      # 5. VERIFY CONNECTION - Health check del cluster
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -n ${{ env.NAMESPACE }}
      
      # 6. HELM UPGRADE - Deploy con nuevo image tag
      - name: Helm upgrade
        run: |
          helm upgrade ${{ env.RELEASE_NAME }} ./helm/spy-trading-bot \
            -f ./helm/spy-trading-bot/values-prod.yaml \
            --set backend.image.tag=${{ github.sha }} \
            --set detector.image.tag=${{ github.sha }} \
            --set bot.image.tag=${{ github.sha }} \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 5m \
            --atomic
      
      # 7. ROLLOUT STATUS - Validar deployment exitoso
      - name: Verify rollout status
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/detector -n ${{ env.NAMESPACE }}
          echo "Deployment successful!"
      
      # 8. HEALTH CHECK - Verificar pods healthy
      - name: Check pod health
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          kubectl get svc -n ${{ env.NAMESPACE }}
      
      # 9. ROLLBACK ON FAILURE - Automation safety
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed! Rolling back..."
          helm rollback ${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }}
          kubectl get pods -n ${{ env.NAMESPACE }}