name: Terraform Plan & Apply

on:
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
  workflow_dispatch:  # Manual trigger

env:
  TF_VERSION: 1.6.0
  WORKING_DIR: ./terraform
  
jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
      # 1. CHECKOUT - Obtener cÃ³digo Terraform
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. SETUP TERRAFORM - Instalar CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # 3. AZURE LOGIN - AutenticaciÃ³n con Service Principal
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # 4. TERRAFORM INIT - Inicializar backend
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init
      
      # 5. TERRAFORM VALIDATE - Sintaxis check
      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate
      
      # 6. TERRAFORM FMT - Code formatting check
      - name: Terraform Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      # 7. TERRAFORM PLAN - Preview cambios
      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform plan -out=tfplan -no-color | tee plan.txt
      
      # 8. COMMENT PR - Publicar plan en PR
      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.WORKING_DIR }}/plan.txt', 'utf8');
            const truncatedPlan = plan.length > 65000 ? plan.substring(0, 65000) + '\n... (truncated)' : plan;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan ðŸ“‹\n\`\`\`\n${truncatedPlan}\n\`\`\``
            });
  
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # 1. CHECKOUT
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. SETUP TERRAFORM
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # 3. AZURE LOGIN
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # 4. TERRAFORM INIT
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init
      
      # 5. TERRAFORM APPLY - Desplegar cambios
      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve
      
      # 6. OUTPUT - Mostrar outputs
      - name: Terraform Output
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform output